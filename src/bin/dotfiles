#!/bin/sh -u

cd "$(dirname "$0")"

__dotfiles_cli__file="./$(basename "$0")"

while [ -L "$__dotfiles_cli__file" ]; do
  __dotfiles_cli__file="$(readlink "$__dotfiles_cli__file")"

  cd "$(dirname "$__dotfiles_cli__file")"

  __dotfiles_cli__file="./$(basename "$__dotfiles_cli__file")"
done

unset -v '__dotfiles_cli__file'

cd '..'

[ "$PWD" != "$(pwd -P)" ] && cd "$(pwd -P)"

[ "$*" = 'dir' ] && echo "$PWD" && exit

__dotfiles_cli__environment_file="$PWD/var/etc/environment.sh"

if [ ! -e "$__dotfiles_cli__environment_file" ]; then
  command "$PWD/libexec/init"

  __dotfiles_cli__init_exit_status=$?

  [ $__dotfiles_cli__init_exit_status -ne 0 ] && exit $__dotfiles_cli__init_exit_status

  unset -v '__dotfiles_cli__init_exit_status'
fi

. "$__dotfiles_cli__environment_file"

unset -v '__dotfiles_cli__environment_file'

[ -x "$DOTFILES_CLI__FILE" ] && command "$DOTFILES_CLI__FILE" "$@"

#!/bin/sh -u

cd "$(dirname "$0")"

__dotfiles_cli__filename="./$(basename "$0")"

while [ -L "$__dotfiles_cli__filename" ]; do
  __dotfiles_cli__filename="$(readlink "$__dotfiles_cli__filename")"

  cd "$(dirname "$__dotfiles_cli__filename")"

  __dotfiles_cli__filename="./$(basename "$__dotfiles_cli__filename")"
done

unset -v '__dotfiles_cli__filename'

cd '..'

[ "$PWD" != "$(pwd -P)" ] && cd "$(pwd -P)"

[ "$*" = 'dir' ] && echo "$PWD" && exit

export DOTFILES_DIR="$PWD"

if [ ! -e "$DOTFILES_DIR/var/dotfiles/properties.sh" ]; then
  "$DOTFILES_DIR/libexec/init"

  __dotfiles_cli__init_exit_status=$?

  [ $__dotfiles_cli__init_exit_status -ne 0 ] && exit $__dotfiles_cli__init_exit_status

  unset -v '__dotfiles_cli__init_exit_status'
fi

if [ -r "$DOTFILES_DIR/var/dotfiles/properties.sh" -a -f "$DOTFILES_DIR/var/dotfiles/properties.sh" ]; then
  . "$DOTFILES_DIR/var/dotfiles/properties.sh"
fi

[ -x "$DOTFILES_CLI__FILE" ] && "$DOTFILES_CLI__FILE" "$@"

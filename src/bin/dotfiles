#!/bin/sh -u
#
# The dotfiles CLI endpoint:
# A POSIX compliant, executable shell wrapper for the dotfiles-cli app.
#

#
# Changing the current working directory to the physical pathname of the dotfiles base package's artifact
#

# Change to the directory of the executed command's file
cd "$(dirname "$0")"

# Determine a relative pathname to that file
__dotfiles_cli__file="./$(basename "$0")"

# Provide a POSIX compliant fallback if readlink is unavailable [1]
if ! command -v 'readlink' > '/dev/null' 2>&1; then
  readlink () {
    set -- "$(ls -dl "$*")" "$*"

    printf "${1#*"$2 -> "}"
  }
fi

# Resolve a possible chain of symlinks to this physical file [2]
while [ -L "$__dotfiles_cli__file" ]; do
  __dotfiles_cli__file="$(readlink "$__dotfiles_cli__file")"

  cd "$(dirname "$__dotfiles_cli__file")"

  __dotfiles_cli__file="./$(basename "$__dotfiles_cli__file")"
done

# The resulting relative filename is not required
unset -v '__dotfiles_cli__file'

# Change to the underlying directory of the canonicalized resulting path
cd -P '..'

#
# Providing the basic `dir` method independently and as early as possible
#

[ "$*" = 'dir' ] && echo "$PWD" && exit

#
# TODO: Initializing
#

__dotfiles_cli__environment_file="$PWD/var/etc/environment.sh"

if [ ! -e "$__dotfiles_cli__environment_file" ]; then
  command './libexec/generate-env-file'

  __dotfiles_cli__init_exit_status=$?

  [ $__dotfiles_cli__init_exit_status -ne 0 ] && exit $__dotfiles_cli__init_exit_status

  unset -v '__dotfiles_cli__init_exit_status'
fi

#
# TODO: Loading
#

. "$__dotfiles_cli__environment_file"

unset -v '__dotfiles_cli__environment_file'

#
# TODO: Invoking and passing
#

[ -x "$DOTFILES_CLI_FILE" ] && command "$DOTFILES_CLI_FILE" "$@"

#
# NOTES:
#  [1]  As the `readlink` utility is not standardized by POSIX, the output of `ls -dl` can be parsed as well (see
#       https://groups.google.com/d/msg/comp.unix.shell/3s8cuwcVnTk/Burr9ThIs9oJ).
#  [2]  Since `readlink -f` is unsupported both on macOS and in the locally provided fallback function, the resolution
#       of (possibly chained) symbolic links has to be done manually (see https://stackoverflow.com/a/1116890 and
#       https://gist.github.com/geoff-codes/1f23957288d371b75a2e#gistcomment-2746338).
#
